# We lightly misuse AppVeyor as a service for building compiled Python wheels
# for windows. As a result, this script does not run any real tests but rather
# checks that the code still compiles under the Windows "C compiler" and then
# dumps out a wheel as a build artefact.
#
# File based heavily on advice from
# http://python-packaging-user-guide.readthedocs.org/en/latest/appveyor/

environment:

  PYPIPASSWORD:
    secure: o5RqpBL+6iPfYTqQpoqfjbAoNGBl2Q8dDTnY0SZ6FsUQOIwba1Jd/1UQ8vZe71v2

  # Build against 32- and 64-bit versions of the supported Python releases.
  matrix:

    # Python 2.7
    - PYTHON: "C:\\Python27"
    - PYTHON: "C:\\Python27-x64"
    # Python 3.4
    - PYTHON: "C:\\Python34"
    - PYTHON: "C:\\Python34-x64"
      DISTUTILS_USE_SDK: "1"
    # Python 3.5
    - PYTHON: "C:\\Python35"
    - PYTHON: "C:\\Python35-x64"

build: off

test_script:
  # The test on windows is simply "can we compile and import the package?". The
  # test suite requires C99 and is executed on a Linux host in Travis CI.
  - "win_build.cmd %PYTHON%\\python.exe setup.py install"
  - "win_build.cmd %PYTHON%\\python.exe -c \"import rig_c_sa\""

on_success:
  - echo [distutils]                                  > %USERPROFILE%\\.pypirc
  - echo index-servers =                             >> %USERPROFILE%\\.pypirc
  - echo     pypi                                    >> %USERPROFILE%\\.pypirc
  - echo [pypi]                                      >> %USERPROFILE%\\.pypirc
  - echo repository=https://testpypi.python.org/pypi >> %USERPROFILE%\\.pypirc
  - echo username=rigbots                            >> %USERPROFILE%\\.pypirc
  - echo password=%PYPIPASSWORD%                     >> %USERPROFILE%\\.pypirc
  - set HOME=%USERPROFILE%
  - "win_build.cmd %PYTHON%\\python.exe -m pip install wheel"
  - if "%APPVEYOR_REPO_TAG%"=="true" ( win_build.cmd %PYTHON%\\python.exe setup.py bdist_wheel upload -r pypi ) else ( echo "Not deploying because not a tagged commit." )

